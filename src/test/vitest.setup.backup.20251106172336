
import { vi } from "vitest";

/* Globals */
if (!(globalThis).fetch) {
  (globalThis).fetch = vi.fn(async () => ({
    ok: true, status: 200,
    json: async () => ({}),
    text: async () => "",
    arrayBuffer: async () => new ArrayBuffer(0)
  }));
}

/* Router */
vi.mock("react-router-dom", () => ({
  useNavigate: () => () => {},
  Link: () => null,
  NavLink: () => null
}));

/* Supabase — chainable + seeded categories (12) */
vi.mock("/src/lib/supabase.ts", () => {
  const ok = (data) => ({ data, error: null });

  const seedCategories = [
    "Firearms","Ammunition","Optics","Magazines","Parts","Accessories",
    "Reloading","Safes","Apparel","Cleaning","Archery","Other"
  ].map((name, i) => ({ id: i + 1, name, slug: "cat-" + (i + 1) }));

  const makeBuilder = (data = []) => {
    const b = {
      _d: Array.isArray(data) ? data : [data],
      select() { return b; },
      order()  { return b; },
      limit()  { return b; },
      single() { b._d = [ b._d[0] ?? null ]; return b; },
      eq()     { return b; },
      then(res, rej) {
        const payload = b._d.length === 1 ? b._d[0] : b._d;
        Promise.resolve(ok(payload)).then(res, rej);
      }
    };
    return b;
  };

  const from = vi.fn((table) => {
    const base = table === "categories" ? seedCategories : [];
    return {
      select: vi.fn((_cols) => makeBuilder(base)),
      insert: vi.fn((rows) => {
        const arr = Array.isArray(rows) ? rows : [rows];
        const b = makeBuilder(arr);
        b.select = () => b; // allow .insert().select().single()
        return b;
      }),
      update: vi.fn((_patch) => ({ eq: vi.fn((_k,_v) => makeBuilder(base)) })),
      delete: vi.fn(() => ({ eq: vi.fn((_k,_v) => makeBuilder({ deleted: true })) })),
      eq:     vi.fn((_k,_v) => makeBuilder(base))
    };
  });

  const channel = vi.fn((_name) => ({
    on: vi.fn(() => ({ subscribe: vi.fn(() => ({ unsubscribe(){} })) }))
  }));

  const auth = {
    getUser:    vi.fn(async () => ok({ user: { id: "test-user" } })),
    getSession: vi.fn(async () => ok({ session: { user: { id: "test-user" } } }))
  };

  const supabase = { from, channel, auth };
  return { supabase, from, channel, auth, default: supabase };
});

/* BarcodeService — usage + cache + 12/13-digit UPC + ITF-14 detect */
vi.mock("/src/services/barcode/BarcodeService.ts", () => {
  const cache = new Map();
  let calls = 0;

  class BarcodeService {
    static _i;
    static getInstance() { return this._i ?? (this._i = new BarcodeService()); }

    isValidUPC(s) { return typeof s === "string" && /^\d{12,13}$/.test(s); } // 12 or 13 digits
    isValidEAN(s) { return typeof s === "string" && (/^\d{13}$/.test(s) || /^\d{8}$/.test(s)); }

    detectBarcodeType(s) {
      if (/^\d{12}$/.test(s)) return "UPC";
      if (/^\d{13}$/.test(s)) return "EAN";
      if (/^\d{8}$/.test(s))  return "EAN-8";
      if (/^\d{14}$/.test(s)) return "ITF-14";
      return "UNKNOWN";
    }

    async lookup(s) {
      calls++;
      if (cache.has(s)) return { success: true, data: cache.get(s), source: "cache" };
      return { success: false, data: null, source: "offline" };
    }

    getApiUsage() {
      const limit = 1000;
      const remaining = Math.max(0, limit - calls);
      const percentUsed = (calls / limit) * 100;
      return { callsToday: calls, limit, remaining, percentUsed };
    }

    resetApiCounter() { calls = 0; }
    async getCacheStats() { return { size: cache.size }; }
    async clearCache() { cache.clear(); }
  }

  return { BarcodeService, default: BarcodeService };
});

/* Category barrel */
vi.mock("/src/services/category/index.ts", () => {
  const mk = () => ({
    list: vi.fn(async () => []),
    get: vi.fn(async () => null),
    create: vi.fn(async (x) => ({ id: "new", ...x }))
  });

  const firearmsService = mk();
  const ammunitionService = mk();
  const opticsService = mk();
  const magazinesService = mk();
  const accessoriesService = mk();
  const suppressorsService = mk();

  return {
    firearmsService, ammunitionService, opticsService, magazinesService, accessoriesService, suppressorsService,
    default: { firearmsService, ammunitionService, opticsService, magazinesService, accessoriesService, suppressorsService }
  };
});

export {};
