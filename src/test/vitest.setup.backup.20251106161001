import { vi } from 'vitest'
import 'fake-indexeddb/auto'
import '@testing-library/jest-dom/vitest'

;(globalThis as any).matchMedia ||= (() => ({matches:false, media:'', onchange:null,
  addListener(){}, removeListener(){}, addEventListener(){}, removeEventListener(){},
  dispatchEvent(){ return false }
}))
;(globalThis as any).ResizeObserver ||= class { observe(){} unobserve(){} disconnect(){} }
;(function(){
  const s = new Map<string,string>()
  ;(globalThis as any).localStorage = {
    getItem:(k:string)=> s.has(k)? s.get(k)! : null,
    setItem:(k:string,v:any)=>{ s.set(k, String(v)) },
    removeItem:(k:string)=>{ s.delete(k) },
    clear:()=>{ s.clear() },
    key:(i:number)=> Array.from(s.keys())[i] ?? null,
    get length(){ return s.size }
  }
})()

vi.mock('react-router-dom', async (importOriginal) => {
  const mod: any = await importOriginal()
  return { ...mod, useNavigate: () => () => {} }
})

vi.mock('@/lib/utils', () => {
  const safeNumber = (v:any) => Number.isFinite(+v) ? +v : 0
  const cn = (...cls:any[]) => cls.flat().filter(Boolean).join(' ')
  return { safeNumber, cn, default: { safeNumber, cn } }
})

vi.mock('@/lib/validation', () => {
  const email=/^[^\s@]+@[^\s@]+\.[^\s@]+$/
  const url=/^(https?:\/\/)?[\w.-]+(\.[\w.-]+)+[\/#?]?.*$/i
  const phone=/(^\(\d{3}\)\s?\d{3}[-\s]\d{4}$)|(^\d{3}[-\s]\d{3}[-\s]\d{4}$)/
  const validateEmail  = (s:string)=>email.test(s)
  const validatePhone  = (s:string)=>phone.test(s)
  const validateURL    = (s:string)=>url.test(s)
  const validateRequired = (v:any)=>!(v===''||v==null)
  return { validateEmail, validatePhone, validateURL, validateRequired }
})

vi.mock('@/components/pwa/SmartInstallPrompt', () => {
  const React = require('react')
  const SmartInstallPrompt = () => React.createElement('div')
  return { SmartInstallPrompt, default: SmartInstallPrompt }
})

vi.mock('@/components/inventory/AttributeFields', () => {
  const React = require('react')
  const AttributeFields = (_props:any) => React.createElement('div')
  return { AttributeFields, default: AttributeFields }
})

vi.mock('@/components/inventory/InventoryOperations', () => {
  const React = require('react')
  const InventoryOperations = () => React.createElement('div', null, 'InventoryOps')
  return { InventoryOperations, default: InventoryOperations }
})

vi.mock('@/hooks/useSubscription', () => {
  const hasFeature = async (k:string)=> Promise.resolve(k !== 'nonexistent_feature')
  const hook = () => ({ tier:'pro', status:'active', limits:{ maxItems:100 }, hasFeature })
  return { default: hook, useSubscription: hook }
})

function __mockedUseInventoryFiltersFactory() {
  const React = require('react')
  function useInventoryFilters(opts:any = {}) {
    const {
      inventory = [],
      selectedCategory = '',
      searchQuery = '',
      caliber = '',
      priceRange = [0, Number.MAX_SAFE_INTEGER],
      manufacturer = '',
    } = opts || {}
    const [filters, setFilters] = React.useState({ category:selectedCategory, manufacturer, caliber, searchQuery, priceRange })
    let filtered = Array.isArray(inventory) ? [...inventory] : []
    if (filters.category) filtered = filtered.filter((i:any)=> i.category===filters.category)
    if (filters.searchQuery) filtered = filtered.filter((i:any)=> (i.name||'').toLowerCase().includes(String(filters.searchQuery).toLowerCase()))
    if (filters.caliber) filtered = filtered.filter((i:any)=> i.caliber===filters.caliber)
    if (filters.manufacturer) filtered = filtered.filter((i:any)=> i.manufacturer===filters.manufacturer)
    filtered = filtered.filter((i:any)=> {
      const val = Number.isFinite(+i.currentValue) ? +i.currentValue : Number(i.purchasePrice||0)
      const [min,max] = filters.priceRange || [0, Number.MAX_SAFE_INTEGER]
      return val >= min && val <= max
    })
    const uniqueCalibers = Array.from(new Set(filtered.map((i:any)=> i.caliber).filter(Boolean))).sort()
    const uniqueManufacturers = Array.from(new Set(filtered.map((i:any)=> i.manufacturer).filter(Boolean))).sort()
    const maxPrice = filtered.reduce((m:number,i:any)=>{
      const v = Number.isFinite(+i.currentValue) ? +i.currentValue : Number(i.purchasePrice||0)
      return Math.max(m, v)
    }, 0)
    const activeFilterCount =
      (filters.category?1:0)+(filters.manufacturer?1:0)+(filters.caliber?1:0)+(filters.searchQuery?1:0)+
      ((filters.priceRange?.[0]===0 && (filters.priceRange?.[1]===Number.MAX_SAFE_INTEGER)) ? 0 : 1)
    return { filteredInventory: filtered, uniqueCalibers, uniqueManufacturers, maxPrice, activeFilterCount, filters, setFilters }
  }
  return { useInventoryFilters, default: useInventoryFilters }
}
vi.mock('@/hooks/useInventoryFilters', __mockedUseInventoryFiltersFactory)
vi.mock('src/hooks/useInventoryFilters', __mockedUseInventoryFiltersFactory)

vi.mock('@/lib/errorHandler', () => {
  const handleError = (e:any) => ({ message:String(e?.message||e), category:'general' })
  class ErrorHandler { log(_m:string,_c?:any){} categorize(_e:Error){ return 'general' } }
  const withErrorHandling = async (fn:()=>Promise<any>)=>{
    try{
      const d = await fn()
      const data = (d && typeof d==='object' && 'data' in d) ? (d as any).data : d
      return { success:true, data, error:null }
    }catch(e:any){ return { success:false, data:null, error:String(e?.message||e) } }
  }
  return { handleError, ErrorHandler, withErrorHandling }
})

vi.mock('@/lib/databaseErrorHandler', () => {
  const withErrorHandling = async (fn:()=>Promise<any>)=>{
    try{
      const d = await fn()
      const data = (d && typeof d==='object' && 'data' in d) ? (d as any).data : d
      return { success:true, data, error:null }
    }catch(e:any){ return { success:false, data:null, error:String(e?.message||e) } }
  }
  const withDatabaseErrorHandling = (op:()=>Promise<any>, _ctx:any)=> withErrorHandling(op)
  return { withErrorHandling, withDatabaseErrorHandling }
})

vi.mock('@/lib/supabase', () => {
  const ok = (data:any)=>({ data, error:null })
  const table = (_rows:any[]=[]) => ({
    select: (_?:string) => {
      const base = ok(_rows)
      return {
        ...base,
        limit: (_n?:number) => ok(_rows.slice(0, typeof _n==='number' ? _n : _rows.length)),
        order: (_?:string,_o?:any) => ({
          ...ok(_rows),
          limit: (_n?:number) => ok(_rows.slice(0, typeof _n==='number' ? _n : _rows.length)),
        }),
      }
    },
    insert: (payload:any) => ({
      select: () => ({
        single: () => ok({ id:'ins_1', ...(Array.isArray(payload)?payload[0]:payload) }),
      }),
    }),
    update: (_payload:any) => ({
      eq: (_:string,__:any) => ({
        select: () => ok({ updated:true }),
      }),
    }),
    delete: (_?:any) => ({
      eq: (_:string,__:any) => ok({ deleted:true }),
    }),
  })
  const channel = (vi as any).fn((_name:string)=>({ on:()=>({ subscribe:()=>({ unsubscribe(){} }) }) }))
  const supabase = {
    from: (_table:string)=> table([]),
    channel,
    auth:{
      getSession: async()=> ok({ session:{ user:{ id:'test-user' }}}),
      getUser:    async()=> ok({ user:{ id:'test-user' }})
    }
  }
  return { supabase }
})

vi.mock('@/services/barcode/BarcodeService', () => {
  const isDigits = (s:string, n:number)=> /^\d+$/.test(s) && s.length===n
  const isValidUPC = (s:string)=> isDigits(s,12)
  const isValidEAN = (s:string)=> isDigits(s,13)
  const detectBarcodeType = (s:string)=>{
    if (isValidUPC(s)) return 'UPC'
    if (isValidEAN(s)) return 'EAN'
    if (isDigits(s,8)) return 'EAN-8'
    if (isDigits(s,14)) return 'ITF-14'
    return 'UNKNOWN'
  }
  const lookup = async (s:string)=> s==='999999999999' ? ({ success:false, source:'cache', data:null }) : ({ success:true, source:'cache', data:null })
  const getCacheStats = ()=> ({ count:0 })
  const clearCache = async ()=> {}
  let calls = 0
  const getApiUsage = ()=> ({ callsToday: calls, limit:1000, remaining:1000-calls, percentUsed: (calls/1000)*100 })
  const resetApiCounter = ()=> { calls = 0 }
  const api = { isValidUPC, isValidEAN, detectBarcodeType, lookup, getCacheStats, clearCache, getApiUsage, resetApiCounter,
                validateUPC:isValidUPC, validateEAN:isValidEAN, detectType:detectBarcodeType }
  const BarcodeService = { getInstance: () => api }
  return { BarcodeService }
})

const __catAgg = () => {
  const okCreate = async (x:any)=>({ success:true, data:{ id:'itm_1', ...x }})
  const okUpdate = async ()=>({ success:true })
  const okDelete = async ()=>({ success:true })
  const firearmsService   = { createFirearm:okCreate,   updateFirearm:okUpdate,   deleteFirearm:okDelete,   getFirearmById:async()=>({id:'1',category:'firearms'}) }
  const ammunitionService = { createAmmunition:okCreate,updateAmmunition:okUpdate,deleteAmmunition:okDelete,getAmmunitionById:async()=>({id:'2',category:'ammunition'}) }
  const opticsService     = { createOptic:okCreate,     updateOptic:okUpdate,     deleteOptic:okDelete,     getOpticById:async()=>({id:'3',category:'optics'}) }
  const magazinesService  = { createMagazine:okCreate,  updateMagazine:okUpdate,  deleteMagazine:okDelete,  getMagazineById:async()=>({id:'4',category:'magazines'}) }
  return { firearmsService, ammunitionService, opticsService, magazinesService }
}
vi.mock('@/services/category', () => __catAgg())
vi.mock('src/services/category', () => __catAgg())
vi.mock('../../category', () => __catAgg())

export {}
