import { vi } from 'vitest';

/* globals */
if (!(globalThis).fetch) { (globalThis).fetch = vi.fn(async () => ({ ok:true, status:200, json:async()=>({}), text:async()=>'', arrayBuffer:async()=>new ArrayBuffer(0) })); }
if (!(globalThis).matchMedia) { (globalThis).matchMedia = () => ({ matches:false, media:'', onchange:null, addListener(){}, removeListener(){}, addEventListener(){}, removeEventListener(){}, dispatchEvent(){ return false; } }); }
if (!(globalThis).ResizeObserver) { (globalThis).ResizeObserver = class { observe(){} unobserve(){} disconnect(){} }; }
if (!(globalThis).localStorage) { const store = new Map(); (globalThis).localStorage = { getItem:k=>store.has(k)?store.get(k):null, setItem:(k,v)=>{store.set(k,String(v));}, removeItem:k=>{store.delete(k);}, clear:()=>{store.clear();} }; }

/* utils and validation */
vi.mock('/src/lib/utils.ts', () => {
  const safeNumber = (v, def = 0) => { const n = Number(v); return Number.isFinite(n) ? n : def; };
  const cn = (...a) => a.filter(Boolean).join(' ');
  return { safeNumber, cn, default: { safeNumber, cn } };
});
vi.mock('/src/lib/validation.ts', () => {
  const email=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; const url=/^(https?:\/\/)?[\w.-]+(\.[\w.-]+)+[\/#?]?.*$/i; const phone=/(^\(\d{3}\)\s?\d{3}[-\s]\d{4}$)|(^\d{3}[-\s]\d{3}[-\s]\d{4}$)/;
  const validateEmail=s=>email.test(s||''); const validatePhone=s=>phone.test(s||''); const validateURL=s=>url.test(s||''); const validateRequired=v=>!(v===''||v==null);
  return { validateEmail, validatePhone, validateURL, validateRequired };
});

/* database error handlers */
vi.mock('/src/lib/databaseErrorHandler.ts', () => {
  const withErrorHandling = async (fn) => { try { return await fn(); } catch (e) { return { data:null, error:e||new Error('mock error') }; } };
  const withDatabaseErrorHandling = async (operation, _ctx) => {
    const { data, error } = await operation();
    if (error) return { data:null, error };
    return { data, error:null };
  };
  return { withErrorHandling, withDatabaseErrorHandling, default:{ withErrorHandling, withDatabaseErrorHandling } };
});

/* supabase with full chains */
vi.mock('/src/lib/supabase.ts', () => {
  const ok = (data) => ({ data, error: null });
  const resp = (data=[]) => ({ ...ok(data), single: async () => ok(Array.isArray(data)?data[0]??null:data), order: async () => ok(data), limit: async () => ok(data) });
  const sel = (data=[]) => ({ ...resp(data), eq: async () => ok(data) });
  const from = vi.fn((table) => ({
    select: vi.fn(async () => sel([])),
    insert: vi.fn(async (rows) => ({ select: async () => ({ single: async () => ok(Array.isArray(rows)?rows[0]??null:rows), ...ok(Array.isArray(rows)?rows: [rows]) }), ...ok(Array.isArray(rows)?rows:[rows]) })),
    update: vi.fn(async () => ({ eq: vi.fn(async () => ok([])) })),
    delete: vi.fn(async () => ({ eq: vi.fn(async () => ok({ deleted:true })) })),
    eq: vi.fn(async () => ok([]))
  }));
  const channel = vi.fn((_name) => ({ on: vi.fn(() => ({ subscribe: vi.fn(() => ({ unsubscribe(){} })) })) }));
  const auth = { getUser: vi.fn(async () => ok({ user:{ id:'test-user' } })), getSession: vi.fn(async () => ok({ session:{ user:{ id:'test-user' } } })) };
  const supabase = { from, channel, auth };
  return { supabase, from, channel, auth, default: supabase };
});

/* useSubscription: stable contract */
vi.mock('/src/hooks/useSubscription.ts', () => {
  const hasFeature = (key) => key !== 'nonexistent_feature';
  const limits = { maxItems: 1000, maxPhotos: 50 };
  const tier = 'pro'; const status = 'active';
  return { useSubscription: () => ({ hasFeature, limits, tier, status }), default: () => ({ hasFeature, limits, tier, status }) };
});

/* useInventoryFilters: basic real logic */
vi.mock('/src/hooks/useInventoryFilters.ts', () => {
  function useInventoryFilters({ inventory = [], selectedCategory, searchQuery, caliber, manufacturer, priceRange } = {}) {
    let filtered = [...inventory];
    if (selectedCategory) filtered = filtered.filter(it => it.category === selectedCategory);
    if (searchQuery) filtered = filtered.filter(it => (it.name||'').toLowerCase().includes(String(searchQuery).toLowerCase()));
    if (caliber) filtered = filtered.filter(it => it.caliber === caliber);
    if (manufacturer) filtered = filtered.filter(it => it.manufacturer === manufacturer);
    if (priceRange && Array.isArray(priceRange)) {
      const [min,max] = priceRange; filtered = filtered.filter(it => { const p = Number(it.price||it.currentValue||it.purchasePrice||0); return p >= (min??0) && p <= (max??Number.MAX_VALUE); });
    }
    const uniqueCalibers = Array.from(new Set(inventory.map(i=>i.caliber).filter(Boolean)));
    const uniqueManufacturers = Array.from(new Set(inventory.map(i=>i.manufacturer).filter(Boolean)));
    const maxPrice = inventory.reduce((m,i)=>Math.max(m, Number(i.price||i.currentValue||i.purchasePrice||0)), 0);
    const activeFilterCount = Number(Boolean(selectedCategory)) + Number(Boolean(searchQuery)) + Number(Boolean(caliber)) + Number(Boolean(manufacturer)) + Number(Boolean(priceRange && priceRange.length));
    return { filteredInventory: filtered, uniqueCalibers, uniqueManufacturers, maxPrice, activeFilterCount };
  }
  return { useInventoryFilters, default: useInventoryFilters };
});

/* BarcodeService full api */
vi.mock('/src/services/barcode/BarcodeService.ts', () => {
  class _BarcodeService {
    static _inst; static getInstance(){ return this._inst ?? (this._inst = new _BarcodeService()); }
    isValidUPC(s){ return typeof s==='string' && /^\d{12,13}$/.test(s); }
    isValidEAN(s){ return typeof s==='string' && /^\d{8}(\d{5})?$/.test(s) || /^\d{13}$/.test(s); }
    detectBarcodeType(s){ if (/^\d{12}$/.test(s)) return 'UPC'; if (/^\d{13}$/.test(s)) return 'EAN'; if (/^\d{8}$/.test(s)) return 'EAN-8'; return 'UNKNOWN'; }
    async lookup(_s){ return { success:true, data:{ type:this.detectBarcodeType(_s) } }; }
    getApiUsage(){ return { callsToday: 0, limit: 1000 }; }
    resetApiCounter(){ return; }
    async getCacheStats(){ return { size: 0 }; }
    async clearCache(){ return; }
  }
  return { BarcodeService: _BarcodeService, default: _BarcodeService };
});

/* Category barrel */
vi.mock('/src/services/category/index.ts', () => {
  const mk = () => ({ create: vi.fn(async (x)=>({ success:true, ...x })), update: vi.fn(async ()=>({ success:true })), delete: vi.fn(async ()=>({ success:true })), get: vi.fn(async ()=>({})), list: vi.fn(async ()=>[]) });
  const firearmsService=mk(), ammunitionService=mk(), opticsService=mk(), magazinesService=mk(), accessoriesService=mk(), suppressorsService=mk();
  return { firearmsService, ammunitionService, opticsService, magazinesService, accessoriesService, suppressorsService, default: { firearmsService, ammunitionService, opticsService, magazinesService, accessoriesService, suppressorsService } };
});

/* InventoryAPIService */
vi.mock('/src/services/api/InventoryAPIService.ts', () => {
  const db = [];
  class InventoryAPIService {
    async getAll(){ return db; }
    async getItems(){ return db; }
    async createItem(item){ const row = { id: String(db.length+1), ...item }; db.push(row); return row; }
    async batchCreate(arr){ const out = arr.map((x,i)=>({ id:String(db.length+i+1), ...x })); db.push(...out); return out; }
    async subscribeToChanges(cb){ cb({ type:'INSERT' }); return { unsubscribe(){} }; }
  }
  return { InventoryAPIService, default: InventoryAPIService };
});

/* StorageService */
vi.mock('/src/services/StorageService.ts', () => {
  class StorageService { constructor(){} async upload(p,_f){ return { path:p, key:'mock' }; } async delete(p){ return { deleted:true, path:p }; } async list(){ return []; } }
  return { StorageService, default: StorageService };
});

/* ReferenceDataService */
vi.mock('/src/services/reference.service.ts', () => {
  class ReferenceDataService {
    async getManufacturers(){ return [{ id:'m1', name:'Acme' }]; }
    async getCalibers(){ return [{ id:'c1', name:'9mm' }]; }
    async addManufacturer(payload){ const name = payload && payload.name ? payload.name : String(payload||''); return { id: 'm'+Date.now(), name }; }
  }
  return { ReferenceDataService, default: ReferenceDataService };
});

/* InventoryOperations component */
vi.mock('/src/components/inventory/InventoryOperations.tsx', () => {
  const React = require('react');
  function InventoryOperations(){ return React.createElement('div', null, 'InventoryOperations'); }
  return { default: InventoryOperations, InventoryOperations };
});

/* SmartInstallPrompt component */
vi.mock('/src/components/pwa/SmartInstallPrompt.tsx', () => {
  const React = require('react');
  function SmartInstallPrompt(){ return React.createElement('div', null, 'SmartInstallPrompt'); }
  return { default: SmartInstallPrompt, SmartInstallPrompt };
});

/* router */
vi.mock('react-router-dom', () => ({ useNavigate: () => () => {}, Link: () => null, NavLink: () => null }));

export {};
