/* eslint-disable @typescript-eslint/no-explicit-any */
import "@testing-library/jest-dom/vitest";
import { vi } from "vitest";

/* ---------- Minimal globals ---------- */
if (!(globalThis as any).fetch) {
  (globalThis as any).fetch = vi.fn(async () => ({
    ok: true, status: 200,
    json: async () => ({}),
    text: async () => "",
    arrayBuffer: async () => new ArrayBuffer(0),
  }));
}

/* ---------- Router ---------- */
vi.mock("react-router-dom", () => ({
  useNavigate: () => () => {},
  Link: () => null,
  NavLink: () => null,
}));

/* ---------- Supabase: seeded categories + simple chain ---------- */
vi.mock("/src/lib/supabase.ts", () => {
  const ok = (data: any) => ({ data, error: null });
  const seed = [
    "Firearms","Ammunition","Bullets","Magazines","Parts","Accessories",
    "Reloading","Safes","Apparel","Cleaning","Archery","Other",
  ].map((name, i) => ({ id: i + 1, name, slug: "cat-" + (i + 1) }));

  const builder = (data: any[] | any = []) => {
    const b: any = {
      _d: Array.isArray(data) ? data : [data],
      select() { return b; },
      order()  { return b; },
      limit()  { return b; },
      eq()     { return b; },
      single() { b._d = [b._d[0] ?? null]; return b; },
      then(res: any, rej: any) {
        const payload = b._d.length === 1 ? b._d[0] : b._d;
        Promise.resolve(ok(payload)).then(res, rej);
      },
    };
    return b;
  };

  const from = vi.fn((table: string) => {
    const base = table === "categories" ? seed : [];
    return {
      select: vi.fn(() => builder(base)),
      insert: vi.fn((rows: any[] | any) => {
        const arr = Array.isArray(rows) ? rows : [rows];
        const b = builder(arr);
        (b as any).select = () => b; // allow .insert().select().single()
        return b;
      }),
      update: vi.fn(() => ({ eq: vi.fn(() => builder(base)) })),
      delete: vi.fn(() => ({ eq: vi.fn(() => builder({ deleted: true })) })),
      eq:     vi.fn(() => builder(base)),
    };
  });

  const channel = vi.fn(() => ({ on: vi.fn(() => ({ subscribe: vi.fn(() => ({ unsubscribe(){} })) })) }));
  const auth = {
    getUser:    vi.fn(async () => ok({ user: { id: "test-user" } })),
    getSession: vi.fn(async () => ok({ session: { user: { id: "test-user" } } })),
  };

  const supabase = { from, channel, auth };
  return { supabase, from, channel, auth, default: supabase };
});

/* ---------- BarcodeService: static getInstance + coverage helpers ---------- */
vi.mock("/src/services/barcode/BarcodeService.ts", () => {
  const cache = new Map<string, unknown>();
  let calls = 0;
  class BarcodeService {
    static _i: BarcodeService | undefined;
    static getInstance() { return this._i ?? (this._i = new BarcodeService()); }
    isValidUPC(s: string) { return typeof s === "string" && /^\d{12,13}$/.test(s); }
    isValidEAN(s: string) { return typeof s === "string" && (/^\d{13}$/.test(s) || /^\d{8}$/.test(s)); }
    detectBarcodeType(s: string) {
      if (/^\d{12}$/.test(s)) return "UPC";
      if (/^\d{13}$/.test(s)) return "EAN";
      if (/^\d{8}$/.test(s))  return "EAN-8";
      if (/^\d{14}$/.test(s)) return "ITF-14";
      return "UNKNOWN";
    }
    async lookup(_s: string) {
      calls++;
      return { success: false, data: null, source: "offline" as const };
    }
    getApiUsage() {
      const limit = 1000;
      const remaining = Math.max(0, limit - calls);
      const percentUsed = (calls / limit) * 100;
      return { callsToday: calls, limit, remaining, percentUsed };
    }
    resetApiCounter() { calls = 0; }
    async getCacheStats() { return { size: cache.size }; }
    async clearCache() { cache.clear(); }
  }
  return { BarcodeService, default: BarcodeService };
});

/* ---------- Category barrel: absolute + relative ---------- */
vi.mock("/src/services/category/index.ts", () => {
  const mk = () => ({
    list: vi.fn(async () => []),
    get: vi.fn(async () => null),
    create: vi.fn(async (x: any) => ({ id: "new", ...x })),
    update: vi.fn(async () => ({ success: true })),
    delete: vi.fn(async () => ({ success: true })),
  });
  const firearmsService = mk();
  const ammunitionService = mk();
  const opticsService = mk();
  const magazinesService = mk();
  const accessoriesService = mk();
  const suppressorsService = mk();
  return {
    firearmsService, ammunitionService, opticsService, magazinesService, accessoriesService, suppressorsService,
    default: { firearmsService, ammunitionService, opticsService, magazinesService, accessoriesService, suppressorsService },
  };
});
vi.mock("../../category", () => {
  const mk = () => ({
    list: vi.fn(async () => []),
    get: vi.fn(async () => null),
    create: vi.fn(async (x: any) => ({ id: "new", ...x })),
  });
  const firearmsService = mk();
  const ammunitionService = mk();
  const opticsService = mk();
  const magazinesService = mk();
  const accessoriesService = mk();
  return {
    firearmsService, ammunitionService, opticsService, magazinesService, accessoriesService,
    default: { firearmsService, ammunitionService, opticsService, magazinesService, accessoriesService },
  };
});

/* ---------- keep ESM happy ---------- */
export {};


if(!(globalThis).matchMedia){ (globalThis).matchMedia=()=>({matches:false,media:"",onchange:null,addListener(){},removeListener(){},addEventListener(){},removeEventListener(){},dispatchEvent(){return false;}}); }
if(!(globalThis).ResizeObserver){ (globalThis).ResizeObserver=class{ observe(){} unobserve(){} disconnect(){} }; }
if(!(globalThis).localStorage){ const _s=new Map(); const api={getItem:k=>_s.has(k)?_s.get(k):null,setItem:(k,v)=>_s.set(k,String(v)),removeItem:k=>_s.delete(k),clear:()=>_s.clear()}; globalThis.localStorage=api; if(typeof window!=="undefined") window.localStorage=api; }

const __mk=()=>({list:vi.fn(async()=>[]),get:vi.fn(async()=>null),create:vi.fn(async x=>({id:"new",...x})),update:vi.fn(async()=>({success:true})),delete:vi.fn(async()=>({success:true}))});
const __cat=()=>{const firearmsService=__mk(),ammunitionService=__mk(),opticsService=__mk(),magazinesService=__mk(),accessoriesService=__mk(),suppressorsService=__mk(),reloadingService=__mk();return{firearmsService,ammunitionService,opticsService,magazinesService,accessoriesService,suppressorsService,reloadingService,default:{firearmsService,ammunitionService,opticsService,magazinesService,accessoriesService,suppressorsService,reloadingService}}};
vi.mock("/src/services/category/index.ts", __master=>__cat());
vi.mock("/src/services/category", __master=>__cat());
vi.mock("src/services/category", __master=>__cat());
vi.mock("@/services/category", __master=>__cat());
vi.mock("../category", __master=>({ ...__cat() }));
vi.mock("../../category", __master=>({ ...__cat() }));
