CaliberVaultII — Red Failures on Current Build

Baseline (unchanged):

main commit: ef8ca1c750f63cd2d034099b8cb203c3e884712f
vitest.out.txt sha256: fbe1099a5e536a59e92f60b9e1363f426529d36ddd8f9e8cd4d7d10fd7da990c
Harness sentinel (runtime): HARNESS:2025-11-11T20:45Z:fa35a7e7

first 3 lines:

 RUN  v2.1.9 /Users/ghogue/Desktop/CaliberVaultII

last 3 lines:
   Start at  09:49:39
   Duration  57.01s (transform 1.91s, setup 15.26s, collect 20.57s, tests 54.83s, environment 61.33s, prepare 5.42s)

Summary from this run:
- failing test lines: 27
- failing files: 11

Failing specs (lines):
 × src/test/integration/data-migration.test.ts > Data Migration Validation > should create ammunition item successfully
 × src/test/integration/data-migration.test.ts > Data Migration Validation > should create magazine item successfully
 × src/test/integration/comprehensive-categories.test.ts > Comprehensive Category Integration Tests > Firearms Service Integration > creates firearm with all fields
 × src/test/integration/comprehensive-categories.test.ts > Comprehensive Category Integration Tests > Ammunition Service Integration > creates ammunition with specifications
 × src/test/integration/api.test.ts > API Integration Tests > REST API Endpoints > fetches inventory items via API
 × src/test/integration/api.test.ts > API Integration Tests > REST API Endpoints > creates item via API
 × src/test/integration/api.test.ts > API Integration Tests > REST API Endpoints > handles API errors gracefully
 × src/test/integration/api.test.ts > API Integration Tests > Real-time Subscriptions > subscribes to inventory changes
 × src/components/__tests__/InventoryOperations.test.tsx > InventoryOperations > renders inventory dashboard
 × src/components/__tests__/InventoryOperations.test.tsx > InventoryOperations > handles inventory operations
 × src/services/__tests__/storage.service.test.ts > StorageService > uploadFile > uploads file successfully
 × src/hooks/__tests__/useSubscription.test.ts > useSubscription > returns subscription data with tier pro 1014ms
 × src/components/__tests__/SmartInstallPrompt.test.tsx > SmartInstallPrompt > shows install button when prompt is available 1010ms
 × src/hooks/__tests__/useSubscription.test.ts > useSubscription > has hasFeature function that returns true 1079ms
 × src/lib/__tests__/errorHandler.test.ts > ErrorHandler > handles errors gracefully
 × src/lib/__tests__/errorHandler.test.ts > ErrorHandler > logs errors
 × src/lib/__tests__/errorHandler.test.ts > ErrorHandler > categorizes errors
 × src/components/__tests__/AddItemModal.test.tsx > AddItemModal > should render when open
 × src/components/__tests__/AddItemModal.enhanced.test.tsx > AddItemModal Enhanced > renders modal with all features
 × src/components/__tests__/AddItemModal.enhanced.test.tsx > AddItemModal Enhanced > handles form validation
 × src/components/__tests__/AddItemModal.enhanced.test.tsx > AddItemModal Enhanced > supports all categories
 × src/hooks/__tests__/useSubscription.test.ts > useSubscription > returns defined limits 1169ms
 × src/lib/__tests__/barcodeCache.test.ts > BarcodeCacheManager > initializes cache manager 10007ms
 × src/lib/__tests__/barcodeCache.test.ts > BarcodeCacheManager > caches barcode data 10002ms
 × src/lib/__tests__/barcodeCache.test.ts > BarcodeCacheManager > retrieves cached data 10003ms
 × src/lib/__tests__/barcodeCache.test.ts > BarcodeCacheManager > returns null for non-existent barcode 10002ms
 × src/lib/__tests__/barcodeCache.test.ts > BarcodeCacheManager > clears all cache 10003ms

Failing files:
src/components/__tests__/AddItemModal.enhanced.test.tsx
src/components/__tests__/AddItemModal.test.tsx
src/components/__tests__/InventoryOperations.test.tsx
src/components/__tests__/SmartInstallPrompt.test.tsx
src/hooks/__tests__/useSubscription.test.ts
src/lib/__tests__/barcodeCache.test.ts
src/lib/__tests__/errorHandler.test.ts
src/services/__tests__/storage.service.test.ts
src/test/integration/api.test.ts
src/test/integration/comprehensive-categories.test.ts
src/test/integration/data-migration.test.ts

Acceptance criteria to turn these green (tests unchanged):

1) Supabase query builder
   - .eq() returns the same builder (repeatable)
   - insert(payload) resolves { data: payload, error: null }
   - .select(), .single(), .maybeSingle(), insert().select() chain

2) Service implementations
   - getAll() returns an array
   - create() returns the created object (not { success:true })
   - error paths reject (throw), not resolve

3) Export/import alignment (InventoryOperations and similar)
   - export form (default vs named) must match the test import

4) Auth surface (same client module the app imports)
   - auth.getSession() -> { data:{ session:{ user:{ id:'test-user' }}}, error:null }
   - auth.onAuthStateChange() -> { data:{ subscription:{ unsubscribe(){} }}}

5) Realtime stub
   - client.channel().on().subscribe(), subscribe() returns { unsubscribe(){} }, spy-able

6) SmartInstallPrompt
   - under test, raise beforeinstallprompt; component calls .prompt() and shows control

7) Barcode cache timing
   - process.env.NODE_ENV==='test' ? 5 : 10000 (no global timeout inflation)

8) ErrorHandler exports
   - default class ErrorHandler and named function handleError

9) Data consistency (migration & API integration)
   - fields and inserted payloads match expected names/values in tests

Delivery (no Git):
- Zip your full local CaliberVaultII folder with tests unchanged
- Include a changelog mapping each fix to files modified
- Include your expected pass/fail counts on unchanged tests
